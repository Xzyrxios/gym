<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Träningsstatistik</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#22d3ee; }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b1022,#0f172a 30%,#0b1022);color:var(--txt)}
    .wrap{max-width:1000px;margin:24px auto;padding:16px}
    .card{background:rgba(255,255,255,.04);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:16px}
    .card h2{margin:0 0 8px}
    h1{font-size:clamp(22px,3.2vw,34px);margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select, input[type="text"], button{font:inherit}
    select, input[type="text"]{background:#0b1224;border:1px solid rgba(255,255,255,.12);border-radius:12px;color:var(--txt);padding:10px 12px;min-height:40px}
    button{background:var(--accent);color:#001018;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;min-height:40px}
    button.ghost{background:transparent;color:var(--txt);border:1px solid rgba(255,255,255,.18)}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .panel{padding:16px}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:700px){ .controls{grid-template-columns:1fr} }
    canvas{max-width:100%;height:420px}
    .hint{font-size:12px;color:#9ae6ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card panel">
      <h1>Statistik <span class="muted">– träningsapp</span></h1>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <span class="pill">Källa: localStorage</span>
          <span class="pill" id="ghStatus">GitHub: ej ansluten</span>
        </div>
        <div class="row" style="gap:8px">
          <button id="pullBtn" class="ghost" title="Hämta traningslogg.json från GitHub">Hämta ← GitHub</button>
          <button id="uploadBtn" class="ghost" title="Läs in JSON från datorn">Läs in JSON…</button>
          <input id="fileInput" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>

    <div class="card panel">
      <div class="controls">
        <label>Välj övning
          <select id="exerciseSelect"></select>
        </label>
        <label>Välj mått
          <select id="metricSelect">
            <option value="maxWeight">Max vikt (kg)</option>
            <option value="bestReps">Bästa reps</option>
            <option value="volume">Volym (reps×vikt)</option>
          </select>
        </label>
        <label>Filter (frivilligt)
          <select id="dayFilter">
            <option value="">Alla dagar</option>
            <option value="1">Endast Dag 1</option>
            <option value="2">Endast Dag 2</option>
            <option value="3">Endast Dag 3</option>
          </select>
        </label>
      </div>
    </div>

    <div class="card panel">
      <h2 style="margin-bottom:6px">Utveckling över tid</h2>
      <canvas id="chart"></canvas>
      <div class="hint" id="noData" style="display:none;margin-top:8px">Ingen data hittades för vald övning/mått.</div>
    </div>

    <div class="card panel">
      <h2 style="margin-bottom:6px">Senaste datapunkter</h2>
      <div id="latestList" class="muted">—</div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ====== Konstanter och helpers ======
    const STORAGE_KEY = 'trainingLogsV1';
    const GH_KEY = 'trainingGithubCfgV1';
    const readLocal = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const writeLocal = logs => localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));

    const uniq = arr => [...new Set(arr)];
    const fmtDate = iso => new Date(iso).toLocaleDateString('sv-SE');

    function computeSeries(logs, exerciseId, metric, dayFilter) {
      // Plocka ut alla pass som innehåller önskad övning
      const rows = [];
      logs.forEach(l => {
        if(dayFilter && String(l.day) !== String(dayFilter)) return;
        const e = (l.entries||[]).find(x => x.id === exerciseId || x.exercise === exerciseId);
        if(!e) return;
        const sets = e.sets || [];
        const weights = sets.map(s => Number(s.weight || 0));
        const reps = sets.map(s => Number(s.reps || 0));
        const maxWeight = Math.max(0, ...weights);
        const bestReps = Math.max(0, ...reps);
        const volume = sets.reduce((acc, s) => acc + (Number(s.weight||0) * Number(s.reps||0)), 0);
        let y = 0;
        if(metric === 'maxWeight') y = maxWeight;
        else if(metric === 'bestReps') y = bestReps;
        else if(metric === 'volume') y = volume;
        rows.push({ x: l.date, y });
      });
      rows.sort((a,b)=> a.x.localeCompare(b.x));
      return rows;
    }

    function buildExerciseList(logs) {
      const names = [];
      logs.forEach(l => (l.entries||[]).forEach(e => names.push(e.id || e.exercise)));
      return uniq(names);
    }

    // ====== GitHub (frivillig hämtning) ======
    const GH = { owner:'', repo:'', branch:'main', path:'data/traningslogg.json', token:'' };
    function loadGhCfg(){ Object.assign(GH, JSON.parse(localStorage.getItem(GH_KEY) || '{}')); updateGhStatus(); }
    function updateGhStatus(){
      const el = document.getElementById('ghStatus');
      if(GH.owner && GH.repo && GH.path && GH.branch){ el.textContent = 'GitHub: konfigurerad'; el.className='pill'; }
      else { el.textContent = 'GitHub: ej ansluten'; el.className='pill'; }
    }
    async function ghGetFile(){
      if(!GH.owner||!GH.repo||!GH.path||!GH.branch||!GH.token) throw new Error('Saknar GitHub-inställningar i din träningsapp. Öppna appens Inställningar först.');
      const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}?ref=${encodeURIComponent(GH.branch)}`;
      const res = await fetch(url, { headers:{ 'Accept':'application/vnd.github+json','Authorization':`Bearer ${GH.token}`,'X-GitHub-Api-Version':'2022-11-28' } });
      if(res.status===404) return null;
      if(!res.ok) throw new Error('GitHub GET misslyckades: '+res.status);
      return await res.json();
    }

    async function pullFromGitHub(){
      try{
        loadGhCfg();
        const obj = await ghGetFile();
        if(!obj){ alert('Filen finns inte i repo ännu. Kör "Synka" i träningsappen först.'); return; }
        const json = JSON.parse(decodeURIComponent(escape(atob(obj.content))));
        writeLocal(json);
        hydrateUI();
        alert('Hämtat från GitHub!');
      }catch(e){ alert('Hämtning misslyckades: '+e.message); }
    }

    // ====== UI och diagram ======
    let chart;
    const exSel = document.getElementById('exerciseSelect');
    const metricSel = document.getElementById('metricSelect');
    const daySel = document.getElementById('dayFilter');
    const noData = document.getElementById('noData');
    const latestList = document.getElementById('latestList');

    function hydrateUI(){
      const logs = readLocal();
      // Övningslista
      const exercises = buildExerciseList(logs);
      exSel.innerHTML = '';
      if(!exercises.length){
        exSel.append(new Option('— Inga övningar funna —',''));
      } else {
        exercises.forEach(n => exSel.append(new Option(n, n)));
      }
      if(exSel.value === '' && exercises.length){ exSel.value = exercises[0]; }
      render();
    }

    function render(){
      const logs = readLocal();
      const exercise = exSel.value;
      const metric = metricSel.value;
      const dayFilter = daySel.value;
      const series = exercise ? computeSeries(logs, exercise, metric, dayFilter) : [];

      if(chart){ chart.destroy(); chart = null; }

      if(!series.length){
        noData.style.display = 'block';
        latestList.innerHTML = '—';
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'', data:[]}] }, options:{responsive:true} });
        return;
      }
      noData.style.display = 'none';

      const labels = series.map(p => p.x);
      const data = series.map(p => p.y);
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(fmtDate),
          datasets: [{
            label: `${exercise} – ${metricSel.options[metricSel.selectedIndex].text}`,
            data,
            tension: 0.25,
            pointRadius: 3,
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks:{ color:'#cbd5e1' } },
            y: { ticks:{ color:'#cbd5e1' }, beginAtZero: true }
          },
          plugins: {
            legend: { labels:{ color:'#e5e7eb' } },
            tooltip: { callbacks:{ label: (ctx)=> `${ctx.parsed.y}` } }
          }
        }
      });

      // Senaste 5 datapunkter
      const latest = series.slice(-5).reverse();
      latestList.innerHTML = latest.map(p => `${fmtDate(p.x)} — ${p.y}`).join('<br/>');
    }

    // ====== Event handlers ======
    document.getElementById('pullBtn').addEventListener('click', pullFromGitHub);
    document.getElementById('uploadBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{ try{ const json = JSON.parse(String(r.result||'[]')); writeLocal(json); hydrateUI(); } catch(e){ alert('Kunde inte läsa JSON: '+e.message); } };
      r.readAsText(f);
    });

    exSel.addEventListener('change', render);
    metricSel.addEventListener('change', render);
    daySel.addEventListener('change', render);

    // Start
    loadGhCfg();
    hydrateUI();
  </script>
</body>
</html>
